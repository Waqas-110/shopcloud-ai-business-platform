{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}ÚˆÛŒØ´ Ø¨ÙˆØ±Úˆ - ShopCloud{% endblock %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
.dashboard-container {
    direction: rtl;
}

.main-content {
    margin-left: 280px !important;
    margin-right: 0 !important;
    width: calc(100% - 280px) !important;
    direction: rtl;
}

.chart-container {
    direction: ltr; /* Chart should remain LTR for proper display */
}

.chart-section h3 {
    direction: rtl;
    text-align: right;
}
</style>
{% endblock %}

{% block dashboard_content %}

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-info">
                    <h3>Rs. {{ today_report.total_sales|floatformat:0|default:"0" }}</h3>
                    <p>Ø¢Ø¬ Ú©ÛŒ ÙØ±ÙˆØ®Øª</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“‹</div>
                <div class="stat-info">
                    <h3>{{ today_report.total_bills|default:"0" }}</h3>
                    <p>Ú©Ù„ Ø¨Ù„Ø²</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“¦</div>
                <div class="stat-info">
                    <h3>{{ user.shop.product_set.count|default:"0" }}</h3>
                    <p>Ú©Ù„ Ù…ØµÙ†ÙˆØ¹Ø§Øª</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-info">
                    <h3>{{ low_stock_products|length|default:"0" }}</h3>
                    <p>Ú©Ù… Ø§Ø³Ù¹Ø§Ú© Ø§Ù„Ø±Ù¹Ø³</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2>ÙÙˆØ±ÛŒ Ø§Ø¹Ù…Ø§Ù„</h2>
            <div class="actions-grid">
                <a href="{% url 'billing:pos' %}" class="action-btn">
                    <i>ğŸ›’</i>
                    <span>Ù†ÛŒØ§ Ø¨Ù„</span>
                </a>
                <a href="{% url 'products:add' %}" class="action-btn">
                    <i>ğŸ“¦</i>
                    <span>Ù…ØµÙ†ÙˆØ¹Ø§Øª Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</span>
                </a>
                <a href="{% url 'reports:dashboard' %}" class="action-btn">
                    <i>ğŸ“Š</i>
                    <span>Ø±Ù¾ÙˆØ±Ù¹Ø³ Ø¯ÛŒÚ©Ú¾ÛŒÚº</span>
                </a>
                <a href="{% url 'ai_insights:dashboard' %}" class="action-btn">
                    <i>ğŸ¤–</i>
                    <span>AI Ø¨ØµÛŒØ±Øª</span>
                </a>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <div class="chart-section">
                <h3>ğŸ“ˆ ÙØ±ÙˆØ®Øª Ú©Ø§ Ø¬Ø§Ø¦Ø²Û (Ø¢Ø®Ø±ÛŒ 30 Ø¯Ù†)</h3>
                <div class="chart-container">
                    <canvas id="salesChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div class="recent-activity">
                <h3>Ø­Ø§Ù„ÛŒÛ Ø³Ø±Ú¯Ø±Ù…ÛŒ</h3>
                <div class="activity-list">
                    {% if today_report.total_bills > 0 %}
                    <div class="activity-item">
                        <div class="activity-icon">âœ…</div>
                        <div class="activity-text">
                            <p><strong>{{ today_report.total_bills }} Ø¨Ù„Ø²</strong> Ø¢Ø¬ Ø¨Ù†Ø§Ø¦Û’ Ú¯Ø¦Û’</p>
                            <small>Ú©Ù„ ÙØ±ÙˆØ®Øª: Rs. {{ today_report.total_sales|floatformat:0 }}</small>
                        </div>
                    </div>
                    {% endif %}
                    {% if low_stock_products %}
                    <div class="activity-item">
                        <div class="activity-icon">âš ï¸</div>
                        <div class="activity-text">
                            <p><strong>{{ low_stock_products|length }} Ù…ØµÙ†ÙˆØ¹Ø§Øª</strong> Ø§Ø³Ù¹Ø§Ú© Ù…ÛŒÚº Ú©Ù…</p>
                            <small>Ø§Ù†ÙˆÛŒÙ†Ù¹Ø±ÛŒ Ù…ÛŒÙ†Ø¬Ù…Ù†Ù¹ Ú†ÛŒÚ© Ú©Ø±ÛŒÚº</small>
                        </div>
                    </div>
                    {% endif %}
                    {% if top_products %}
                    <div class="activity-item">
                        <div class="activity-icon">ğŸ†</div>
                        <div class="activity-text">
                            <p><strong>Ø¨ÛØªØ±ÛŒÙ† Ù…ØµÙ†ÙˆØ¹Ø§Øª:</strong> {{ top_products.0.product__name }}</p>
                            <small>{{ top_products.0.total_quantity }} ÛŒÙˆÙ†Ù¹Ø³ ÙØ±ÙˆØ®Øª ÛÙˆØ¦Û’</small>
                        </div>
                    </div>
                    {% endif %}
                    {% if not today_report.total_bills and not low_stock_products %}
                    <div class="activity-item">
                        <div class="activity-icon">ğŸ‰</div>
                        <div class="activity-text">
                            <p><strong>ShopCloud Ù…ÛŒÚº Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</strong></p>
                            <small>Ø§Ù¾Ù†Ø§ Ù¾ÛÙ„Ø§ Ø¨Ù„ Ø¨Ù†Ø§Ù†Ø§ Ø´Ø±ÙˆØ¹ Ú©Ø±ÛŒÚº</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Top Products & Low Stock -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div class="products-section">
                <h3>Ø¨ÛØªØ±ÛŒÙ† Ù…ØµÙ†ÙˆØ¹Ø§Øª (Ø¢Ø®Ø±ÛŒ 7 Ø¯Ù†)</h3>
                {% if top_products %}
                <ul class="product-list">
                    {% for product in top_products %}
                    <li class="product-item">
                        <span class="product-name">{{ product.product__name }}</span>
                        <span class="product-value">{{ product.total_quantity }} ÙØ±ÙˆØ®Øª ÛÙˆØ¦Û’</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“¦</div>
                    <p>Ø§Ø¨Ú¾ÛŒ ØªÚ© ÙØ±ÙˆØ®Øª Ú©Ø§ ÚˆÛŒÙ¹Ø§ Ù†ÛÛŒÚº</p>
                </div>
                {% endif %}
            </div>

            <div class="products-section">
                <h3>Ú©Ù… Ø§Ø³Ù¹Ø§Ú© Ø§Ù„Ø±Ù¹Ø³</h3>
                {% if low_stock_products %}
                <ul class="product-list">
                    {% for product in low_stock_products %}
                    <li class="product-item">
                        <span class="product-name">{{ product.name }}</span>
                        <span class="product-value" style="color: #ef4444;">{{ product.stock }} Ø¨Ø§Ù‚ÛŒ</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">âœ…</div>
                    <p>ØªÙ…Ø§Ù… Ù…ØµÙ†ÙˆØ¹Ø§Øª Ø§Ø³Ù¹Ø§Ú© Ù…ÛŒÚº ÛÛŒÚº</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- AI Suggestions Panel -->
        <div class="ai-suggestions">
            <h3>ğŸ¤– AI ØªØ¬Ø§ÙˆÛŒØ²</h3>
            {% if today_report.total_bills == 0 %}
            <div class="suggestion-card">
                <p><strong>Ø´Ø±ÙˆØ¹ Ú©Ø±ÛŒÚº:</strong> ÙØ±ÙˆØ®Øª Ø§ÙˆØ± Ø§Ù†ÙˆÛŒÙ†Ù¹Ø±ÛŒ Ú©Ùˆ Ù¹Ø±ÛŒÚ© Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ø§Ù¾Ù†Ø§ Ù¾ÛÙ„Ø§ Ø¨Ù„ Ø¨Ù†Ø§Ø¦ÛŒÚºÛ”</p>
            </div>
            {% endif %}
            {% if low_stock_products %}
            <div class="suggestion-card">
                <p><strong>Ø§Ø³Ù¹Ø§Ú© Ø§Ù„Ø±Ù¹:</strong> {{ low_stock_products|length }} Ù…ØµÙ†ÙˆØ¹Ø§Øª Ú©Ù… ÛÛŒÚºÛ” Ø¬Ù„Ø¯ Ø¯ÙˆØ¨Ø§Ø±Û Ø§Ø³Ù¹Ø§Ú© Ú©Ø±Ù†Û’ Ù¾Ø± ØºÙˆØ± Ú©Ø±ÛŒÚºÛ”</p>
            </div>
            {% endif %}
            {% if month_report.total_sales > 0 %}
            <div class="suggestion-card">
                <p><strong>Ù…Ø§ÛØ§Ù†Û Ú©Ø§Ø±Ú©Ø±Ø¯Ú¯ÛŒ:</strong> Ø§Ø³ Ù…ÛÛŒÙ†Û’ Ø¢Ù¾ Ú©ÛŒ Ú©Ù„ ÙØ±ÙˆØ®Øª Rs. {{ month_report.total_sales|floatformat:0 }} ÛÛ’Û” Ø¨ÛØªØ±ÛŒÙ† Ù¾ÛŒØ´ Ø±ÙØª!</p>
            </div>
            {% endif %}
            {% if not low_stock_products and today_report.total_bills > 0 %}
            <div class="suggestion-card">
                <p><strong>Ù¹Ù¾:</strong> ØªÛŒØ² Ø¨Ù„Ù†Ú¯ Ø§ÙˆØ± Ø§Ù†ÙˆÛŒÙ†Ù¹Ø±ÛŒ Ù…ÛŒÙ†Ø¬Ù…Ù†Ù¹ Ú©Û’ Ù„ÛŒÛ’ Ø¨Ø§Ø±Ú©ÙˆÚˆ Ø³Ú©ÛŒÙ†Ù†Ú¯ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±ÛŒÚºÛ”</p>
            </div>
            {% endif %}
        </div>
{% endblock %}

{% block dashboard_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Sales Chart - Urdu Version
fetch('/dashboard/api/chart-data/?type=daily_sales&days=30')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('salesChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(item => {
                    const date = new Date(item.date);
                    return date.toLocaleDateString('ur-PK', { month: 'short', day: 'numeric' });
                }),
                datasets: [{
                    label: 'ÛŒÙˆÙ…ÛŒÛ ÙØ±ÙˆØ®Øª (Rs.)',
                    data: data.map(item => item.sales),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'Rs. ' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                elements: {
                    point: {
                        radius: 4,
                        hoverRadius: 6
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error loading chart data:', error);
        document.getElementById('salesChart').parentElement.innerHTML = 
            '<div class="chart-error"><p>ğŸ“ˆ Ú†Ø§Ø±Ù¹ ÚˆÛŒÙ¹Ø§ Ù„ÙˆÚˆ Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©Ø§</p><small>Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§Ù¾Ù†Ø§ Ø§Ù†Ù¹Ø±Ù†ÛŒÙ¹ Ú©Ù†Ú©Ø´Ù† Ú†ÛŒÚ© Ú©Ø±ÛŒÚº</small></div>';
    });
</script>
{% endblock %}