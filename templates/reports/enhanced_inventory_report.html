{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Inventory Report - Enhanced{% endblock %}

{% block dashboard_css %}
<style>
.dashboard-container {
    display: flex;
    min-height: calc(100vh - 70px);
    background: #f8f9fa;
}

.main-content {
    flex: 1;
    margin-left: 280px;
    padding: 30px;
    transition: margin-left 0.3s ease;
}

.report-header {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.inventory-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    text-align: center;
    transition: all 0.3s;
    border-left: 4px solid transparent;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.stat-card.total { border-left-color: #3b82f6; }
.stat-card.low-stock { border-left-color: #f59e0b; }
.stat-card.out-stock { border-left-color: #ef4444; }
.stat-card.value { border-left-color: #10b981; }

.filters-section {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    align-items: end;
}

.search-section {
    background: white;
    padding: 20px 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.search-box {
    position: relative;
    max-width: 400px;
}

.search-box input {
    width: 100%;
    padding: 12px 45px 12px 15px;
    border: 2px solid #e5e7eb;
    border-radius: 25px;
    font-size: 16px;
    transition: all 0.3s;
}

.search-box input:focus {
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.search-box button {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    background: #10b981;
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
}

.inventory-table {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    overflow: hidden;
    margin-bottom: 30px;
}

.table-header {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 20px 25px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stock-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.stock-normal {
    background: #dcfce7;
    color: #166534;
}

.stock-low {
    background: #fef3c7;
    color: #92400e;
}

.stock-out {
    background: #fef2f2;
    color: #dc2626;
}

.category-analysis {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.category-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: all 0.3s;
}

.category-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.pagination-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 30px;
}

.pagination {
    display: flex;
    gap: 5px;
}

.pagination a, .pagination span {
    padding: 10px 15px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    text-decoration: none;
    color: #374151;
    transition: all 0.3s;
}

.pagination a:hover {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.pagination .current {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.movement-analysis {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

.movement-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

.movement-card h4 {
    margin: 0 0 20px 0;
    color: #1f2937;
    font-weight: 700;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 15px;
}

.product-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f1f5f9;
}

.product-item:last-child {
    border-bottom: none;
}

@media (max-width: 768px) {
    .main-content {
        margin-left: 0;
        padding: 20px 15px;
    }
    
    .filters-grid {
        grid-template-columns: 1fr;
    }
    
    .movement-analysis {
        grid-template-columns: 1fr;
    }
    
    .category-analysis {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block dashboard_content %}
        <div class="report-header">
            <h1>üì¶ Inventory Report</h1>
            <p>Complete inventory analysis and stock management overview</p>
        </div>

        <!-- Inventory Stats -->
        <div class="inventory-stats">
            <div class="stat-card total">
                <div class="stat-value">{{ total_products }}</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-card low-stock">
                <div class="stat-value">{{ low_stock_count }}</div>
                <div class="stat-label">Low Stock Items</div>
            </div>
            <div class="stat-card out-stock">
                <div class="stat-value">{{ out_of_stock_count }}</div>
                <div class="stat-label">Out of Stock</div>
            </div>
            <div class="stat-card value">
                <div class="stat-value">‚Ç®{{ total_sale_value|floatformat:0 }}</div>
                <div class="stat-label">Total Inventory Value</div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <form method="get" class="search-box">
                <input type="text" name="search" placeholder="Search products by name, barcode, or category..." 
                       value="{{ current_filters.search }}">
                <button type="submit">üîç</button>
                {% for key, value in current_filters.items %}
                    {% if key != 'search' and value %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}
            </form>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <form method="get" class="filters-grid">
                <div class="form-group">
                    <label>Category</label>
                    <select name="category" class="form-control">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" 
                                {% if current_filters.category == category.id|stringformat:"s" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Stock Status</label>
                    <select name="stock_status" class="form-control">
                        <option value="">All Items</option>
                        <option value="normal" {% if current_filters.stock_status == 'normal' %}selected{% endif %}>Normal Stock</option>
                        <option value="low" {% if current_filters.stock_status == 'low' %}selected{% endif %}>Low Stock</option>
                        <option value="out" {% if current_filters.stock_status == 'out' %}selected{% endif %}>Out of Stock</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sort By</label>
                    <select name="sort" class="form-control">
                        <option value="name" {% if current_filters.sort == 'name' %}selected{% endif %}>Name</option>
                        <option value="stock" {% if current_filters.sort == 'stock' %}selected{% endif %}>Stock Level</option>
                        <option value="value" {% if current_filters.sort == 'value' %}selected{% endif %}>Stock Value</option>
                        <option value="sales" {% if current_filters.sort == 'sales' %}selected{% endif %}>Sales Performance</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
                <input type="hidden" name="search" value="{{ current_filters.search }}">
            </form>
        </div>

        <!-- Category Analysis -->
        <div class="category-analysis">
            {% for category in category_stats %}
            <div class="category-card">
                <h4>{{ category.name }}</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">{{ category.product_count }}</div>
                        <div style="color: #6b7280; font-size: 0.9rem;">Products</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">‚Ç®{{ category.total_value|floatformat:0 }}</div>
                        <div style="color: #6b7280; font-size: 0.9rem;">Total Value</div>
                    </div>
                </div>
                {% if category.low_stock_count > 0 %}
                <div style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 8px; color: #92400e;">
                    ‚ö†Ô∏è {{ category.low_stock_count }} items need restocking
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Fast/Slow Moving Analysis -->
        <div class="movement-analysis">
            <div class="movement-card">
                <h4>üöÄ Fast Moving Products</h4>
                {% for product in fast_moving %}
                <div class="product-item">
                    <div>
                        <strong>{{ product.name }}</strong>
                        <div style="font-size: 0.85rem; color: #6b7280;">Turnover: {{ product.turnover_rate|floatformat:1 }}x</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600;">{{ product.stock }} units</div>
                        <div style="font-size: 0.85rem; color: #10b981;">‚Ç®{{ product.total_revenue|floatformat:0 }}</div>
                    </div>
                </div>
                {% empty %}
                <p style="text-align: center; color: #6b7280; margin: 20px 0;">No fast moving products found</p>
                {% endfor %}
            </div>
            
            <div class="movement-card">
                <h4>üêå Slow Moving Products</h4>
                {% for product in slow_moving %}
                <div class="product-item">
                    <div>
                        <strong>{{ product.name }}</strong>
                        <div style="font-size: 0.85rem; color: #6b7280;">Turnover: {{ product.turnover_rate|floatformat:1 }}x</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600;">{{ product.stock }} units</div>
                        <div style="font-size: 0.85rem; color: #ef4444;">‚Ç®{{ product.stock_value|floatformat:0 }}</div>
                    </div>
                </div>
                {% empty %}
                <p style="text-align: center; color: #6b7280; margin: 20px 0;">No slow moving products found</p>
                {% endfor %}
            </div>
        </div>

        <!-- Products Table -->
        <div class="inventory-table">
            <div class="table-header">
                <h3>üìã Product Inventory</h3>
                <div>Showing {{ products|length }} of {{ all_products|length }} products</div>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Stock Level</th>
                            <th>Stock Value</th>
                            <th>Sales Performance</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td>
                                <strong>{{ product.name }}</strong>
                                {% if product.barcode %}
                                <div style="font-size: 0.8rem; color: #6b7280;">{{ product.barcode }}</div>
                                {% endif %}
                            </td>
                            <td>{{ product.category.name|default:"Uncategorized" }}</td>
                            <td>
                                <strong>{{ product.stock }}</strong> units
                                <div style="font-size: 0.8rem; color: #6b7280;">Min: {{ product.min_stock_alert }}</div>
                            </td>
                            <td>
                                <strong>‚Ç®{{ product.stock_value|floatformat:0 }}</strong>
                                <div style="font-size: 0.8rem; color: #6b7280;">Cost: ‚Ç®{{ product.cost_value|floatformat:0 }}</div>
                            </td>
                            <td>
                                <div>{{ product.total_sold|default:0 }} sold</div>
                                <div style="font-size: 0.8rem; color: #10b981;">‚Ç®{{ product.total_revenue|default:0|floatformat:0 }}</div>
                            </td>
                            <td>
                                {% if product.stock == 0 %}
                                <span class="stock-badge stock-out">Out of Stock</span>
                                {% elif product.stock <= product.min_stock_alert %}
                                <span class="stock-badge stock-low">Low Stock</span>
                                {% else %}
                                <span class="stock-badge stock-normal">Normal</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center" style="padding: 40px;">
                                <div style="color: #6b7280;">
                                    <div style="font-size: 3rem; margin-bottom: 15px;">üì¶</div>
                                    <p>No products found matching your criteria</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="pagination-wrapper">
            <div class="pagination">
                {% if page_obj.has_previous %}
                <a href="?{% for key, value in current_filters.items %}{% if value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">First</a>
                <a href="?{% for key, value in current_filters.items %}{% if value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Previous</a>
                {% endif %}
                
                <span class="current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                
                {% if page_obj.has_next %}
                <a href="?{% for key, value in current_filters.items %}{% if value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Next</a>
                <a href="?{% for key, value in current_filters.items %}{% if value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">Last</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
{% endblock %}